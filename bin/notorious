#! /usr/bin/env ruby

require 'notorious'
require 'optparse'

def parse
  options = {}

  opts = OptionParser.new do |opts|
    opts.banner = "Usage: notorious [options] [action] file"
    opts.separator ""
    opts.separator "actions:"
    opts.separator "    build [file]                     The markdown file to build."

    opts.separator ""
    opts.separator "options:"

    opts.on("-o", "--output [file]", String,
      "Specify output file name (defaults to input_file.html)") do |o|
      o = Notorious.ensure_extension(o, "html")
      options[:output] = o
    end

    opts.on("-s", "--stylesheet [file]", String,
      "Specify a custom stylesheet") do |s|
      s = Notorious.ensure_extension(s, "css")
      options[:stylesheet] = s
    end

    opts.on("-v", "--verbose", "Run verbosely") do |v|
      options[:verbose] = v
    end

  end
  opts.parse!
end

# Parse options
options = parse

# assign arguments
unless ARGV[0]
  puts "Notorious. Run `notorious --help` for details"
end
options[:file_name] = ARGV[1] || raise(ArgumentError, "you must specify a file to build")

# must be a markdown file
Notorious.validate_extension(options[:file_name], ["md", "mdown", "markdown", "Markdown"])

options[:stylesheet] ||= 'default.css'
unless options[:output]
  split = options[:file_name].split('.')
  split.pop if split.length > 1
  options[:output] = split.push('html').join('.')
end

# read in the stylesheet
options[:stylesheet] = File.expand_path("../../stylesheets/#{options[:stylesheet]}", __FILE__)


# Decide what to call
case ARGV[0]
when "build"
  Notorious.build(options)
when "publish"
  #Notorious.publish(file_name, styles_path, output)
else
  raise ArgumentError, "you have specified an invalid command"
end


